diff --git a/index.html b/index.html
index 2fba36aa112d17b4c043efcfd36e78d90ba153ad..a73edd4238cf986cf04a3d16fc35f5a6e226268f 100644
--- a/index.html
+++ b/index.html
@@ -227,128 +227,202 @@
       <button class="btn" id="btnExportReport">Экспорт .txt</button>
     </div>
     <pre id="reportText" style="margin-top:8px;"></pre>
   </div>
 </div>
 
 <div id="tooltip" class="tooltip"></div>
 
 <script src="xlsx.full.min.js"></script>
 <script src="arquero.min.js"></script>
 <script src="dayjs.min.js"></script>
 
 <script>
 /* ====== СОСТОЯНИЕ ====== */
 const S = {
   raw: [],
   filtered: [],
   uniques: { projects:[], types:[], people:[], dates:[] },
   limits: { min:null, max:null },
   filename: "",
   sheets: [],
   stack: [],
   fwd: []
 };
 const aq = window.aq;
+const sourceTableState = { rendered: 0, chunk: 1500 };
 
 /* ====== DOM ====== */
 const el = {
   layoutTop: document.getElementById("layoutTop"),
   cardUpload: document.getElementById("card-upload"),
   cardSheet: document.getElementById("card-sheet"),
   cardDates: document.getElementById("card-dates"),
   cardFilters: document.getElementById("card-filters"),
   cardSource: document.getElementById("card-source"),
 
   file: document.getElementById("fileInput"),
   btnClear: document.getElementById("btnClear"),
   sheetSel: document.getElementById("sheetSel"),
   status: document.getElementById("status"),
   loading: document.getElementById("loading"),
   errBox: document.getElementById("errBox"),
   errText: document.getElementById("errText"),
   periodInfo: document.getElementById("periodInfo"),
   dateFrom: document.getElementById("dateFrom"),
   dateTo: document.getElementById("dateTo"),
   project: document.getElementById("projectSel"),
   type: document.getElementById("typeSel"),
   person: document.getElementById("personSel"),
   btnBack: document.getElementById("btnBack"),
   btnForward: document.getElementById("btnForward"),
   btnReset: document.getElementById("btnReset"),
   btnExportRaw: document.getElementById("btnExportRaw"),
   kpis: document.getElementById("kpis"),
   charts: document.getElementById("charts"),
   chartsToolbar: document.getElementById("chartsToolbar"),
   ctxLabel: document.getElementById("ctxLabel"),
   tbodySrc: document.querySelector("#srcTable tbody"),
+  srcScroll: document.getElementById("srcScroll"),
   srcCount: document.getElementById("srcCount"),
   svgProj: document.getElementById("svgProj"),
   svgPeople: document.getElementById("svgPeople"),
   svgTypes: document.getElementById("svgTypes"),
   svgDates: document.getElementById("svgDates"),
   tooltip: document.getElementById("tooltip"),
 
   btnProjBack: document.getElementById("btnProjBack"),
   btnPeopleBack: document.getElementById("btnPeopleBack"),
   btnTypesBack: document.getElementById("btnTypesBack"),
   btnDatesBack: document.getElementById("btnDatesBack"),
   btnProjFwd: document.getElementById("btnProjFwd"),
   btnPeopleFwd: document.getElementById("btnPeopleFwd"),
   btnTypesFwd: document.getElementById("btnTypesFwd"),
   btnDatesFwd: document.getElementById("btnDatesFwd"),
   btnProjPNG: document.getElementById("btnProjPNG"),
   btnPeoplePNG: document.getElementById("btnPeoplePNG"),
   btnTypesPNG: document.getElementById("btnTypesPNG"),
   btnDatesPNG: document.getElementById("btnDatesPNG"),
 
   h3Proj: document.getElementById("h3Proj"),
   h3People: document.getElementById("h3People"),
   h3Types: document.getElementById("h3Types"),
   h3Dates: document.getElementById("h3Dates"),
 
   report: document.getElementById("report"),
   reportText: document.getElementById("reportText"),
   btnCopyReport: document.getElementById("btnCopyReport"),
   btnExportReport: document.getElementById("btnExportReport"),
 };
 
 /* ====== УТИЛИТЫ ====== */
 const fmt2 = n => (Number.isFinite(n) ? n.toFixed(2) : "0.00");
 const $esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
 function showLoading(on){ el.loading.style.display = on ? "flex" : "none"; }
 function setControlsEnabled(on){ [el.dateFrom, el.dateTo, el.project, el.type, el.person, el.btnBack, el.btnForward, el.btnReset, el.btnExportRaw, el.sheetSel].forEach(x => x.disabled = !on); }
 function showError(err, extras){
   el.errBox.style.display = "block";
   const lines = [];
   if (err && err.message) lines.push(err.message);
   if (err && err.stack) lines.push(err.stack.split("\n").slice(0,3).join("\n"));
   if (extras) lines.push(String(extras));
   el.errText.textContent = lines.join("\n\n");
 }
 function clearError(){ el.errBox.style.display = "none"; el.errText.textContent = ""; }
-function hhmmToDec(s) { if (typeof s !== "string" || !s.includes(":")) return NaN; const [hh, mm] = s.split(":").map(x => parseInt(x||"0",10)); return (hh||0)+(mm||0)/60; }
+function normalizeHours(value){
+  const info = { value: 0, ok: false, missing: false, invalid: false, negative: false, malformed: false };
+  if (value == null || value === "") { info.missing = true; info.invalid = true; return info; }
+  if (typeof value === "number") {
+    if (Number.isFinite(value)) {
+      info.value = value;
+      info.ok = true;
+      info.negative = value < 0;
+      return info;
+    }
+    info.invalid = true;
+    info.malformed = true;
+    return info;
+  }
+
+  let str = String(value).replace(/\u00A0/g, " ").replace(/[−–—]/g, "-").trim();
+  if (!str) { info.missing = true; info.invalid = true; return info; }
+
+  str = str.replace(/(час(ов|а)?|ч\.?|hrs?|hours?)/gi, "");
+  let sanitized = str.replace(/[^0-9.,:+-]/g, "");
+  if (!sanitized) { info.invalid = true; info.malformed = true; return info; }
+
+  let sign = 1;
+  if (sanitized.startsWith("-")) { sign = -1; sanitized = sanitized.slice(1); }
+  else if (sanitized.startsWith("+")) { sanitized = sanitized.slice(1); }
+  sanitized = sanitized.trim();
+
+  if (!sanitized) { info.missing = true; info.invalid = true; return info; }
+
+  if (sanitized.includes(":")) {
+    const parts = sanitized.split(":").map(p => p === "" ? "0" : p);
+    if (parts.length >= 2) {
+      const hh = parseInt(parts[0], 10);
+      const mm = parseInt(parts[1], 10);
+      const ss = parts.length > 2 ? parseInt(parts[2], 10) : 0;
+      if ([hh, mm, ss].every(n => Number.isFinite(n))) {
+        info.value = sign * ((hh || 0) + (mm || 0) / 60 + (ss || 0) / 3600);
+        info.ok = true;
+      }
+    }
+  }
+
+  if (!info.ok) {
+    let cleaned = sanitized;
+    if (cleaned.includes(",") && cleaned.includes(".")) {
+      const lastSep = Math.max(cleaned.lastIndexOf(","), cleaned.lastIndexOf("."));
+      const intPart = cleaned.slice(0, lastSep).replace(/[.,]/g, "");
+      const fracPart = cleaned.slice(lastSep + 1);
+      cleaned = intPart + "." + fracPart;
+    } else {
+      cleaned = cleaned.replace(/,/g, ".");
+      const firstDot = cleaned.indexOf(".");
+      if (firstDot !== -1) {
+        cleaned = cleaned.slice(0, firstDot + 1) + cleaned.slice(firstDot + 1).replace(/\./g, "");
+      }
+    }
+    if (cleaned) {
+      const num = Number(cleaned);
+      if (Number.isFinite(num)) {
+        info.value = sign * num;
+        info.ok = true;
+      }
+    }
+  }
+
+  info.negative = info.value < 0;
+  if (!info.ok) {
+    info.value = 0;
+    if (!info.missing) info.malformed = true;
+    info.invalid = true;
+  }
+  return info;
+}
 function downloadText(filename, text) { const blob=new Blob([text],{type:"text/plain;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove(); }
 function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
 function shortLabel(str, max=42){ const s = String(str||""); return s.length>max ? s.slice(0,max-1)+"…" : s; }
 
 /* Tooltip */
 function showTip(html, x, y){
   el.tooltip.innerHTML = html;
   el.tooltip.style.display = "block";
   const pad = 10;
   const rect = el.tooltip.getBoundingClientRect();
   let left = x + pad, top = y + pad;
   if (left + rect.width > window.innerWidth - 8) left = x - rect.width - pad;
   if (top + rect.height > window.innerHeight - 8) top = y - rect.height - pad;
   el.tooltip.style.left = left + "px";
   el.tooltip.style.top = top + "px";
 }
 function hideTip(){ el.tooltip.style.display = "none"; }
 
 /* Синхронизируем фикс-высоту правого блока */
 function syncRightHeight(){
   const gap = 16;
   const h = el.cardUpload.getBoundingClientRect().height
           + el.cardSheet.getBoundingClientRect().height
           + el.cardDates.getBoundingClientRect().height
           + el.cardFilters.getBoundingClientRect().height
@@ -410,64 +484,69 @@ async function parseWorkbook(file, sheetIndex=-1){
     }
     el.sheetSel.value = String(chosenIdx);
     el.sheetSel.disabled = false;
 
     const sheetName = S.sheets[chosenIdx];
     const sheet = wb.Sheets[sheetName];
 
     let headerRow = findHeaderRow(getSheetRows(wb, sheetName, 250));
 
     const rows = XLSX.utils.sheet_to_json(sheet, {
       defval:null, blankrows:false, raw:true, range: headerRow
     });
     if (!rows.length) throw new Error(`Лист «${sheetName}» пуст (0 строк данных).`);
 
     const keys = Object.keys(rows[0] || {}).map(k => String(k));
     const findKey = (alts) => keys.find(k => alts.some(a => k.toLowerCase().includes(a)));
     const dateKey   = findKey(["дата","date","день"]);
     const projectKey= findKey(["проект","project","портфель"]);
     const typeKey   = findKey(["вид","работ","type","category"]);
     const personKey = findKey(["сотр","исполн","фио","name","employee","user"]);
     const hoursKey  = findKey(["час","hours","time","duration","труд","затрат"]);
 
     S.raw = rows.map(r => {
       let d = toISO(r && dateKey ? r[dateKey] : null);
       if (!d) d = "(нет даты)";
-      let h = (r && hoursKey ? r[hoursKey] : null);
-      if (typeof h === "string" && h.includes(":")) h = hhmmToDec(h);
-      h = parseFloat(h);
+      const hoursRaw = r && hoursKey ? r[hoursKey] : null;
+      const hInfo = normalizeHours(hoursRaw);
 
       const projDisp   = displayOf(r && projectKey ? r[projectKey] : null);
       const typeDisp   = displayOf(r && typeKey    ? r[typeKey]    : null);
       const personDisp = displayOf(r && personKey  ? r[personKey]  : null);
 
       return {
         date: d,
         projectDisp: projDisp, projectKey: normalizeKey(projDisp),
         typeDisp:    typeDisp, typeKey:    normalizeKey(typeDisp),
         personDisp:  personDisp, personKey: normalizeKey(personDisp),
-        hours: Number.isFinite(h) ? h : 0
+        hours: hInfo.value,
+        hoursValid: hInfo.ok,
+        hoursInvalid: hInfo.invalid,
+        hoursMissing: hInfo.missing,
+        hoursMalformed: hInfo.malformed,
+        hoursNegative: hInfo.negative,
+        hoursRaw: hoursRaw
       };
     });
 
     buildUniques();
 
     const dates = S.uniques.dates;
     S.limits.min = dates[0] || "";
     S.limits.max = dates[dates.length-1] || "";
 
     initFiltersUI();
     applyFiltersAndRender(false);
 
     el.status.textContent = `Готово: записей ${S.raw.length}. Период: ${S.limits.min || "—"} — ${S.limits.max || "—"}`;
   }catch(err){
     console.error(err);
     showError(err, `Файл: ${S.filename || "(нет)"} | Листы: ${S.sheets.join(", ") || "(нет)"} | Библиотеки: XLSX=${!!window.XLSX}, aq=${!!window.aq}, dayjs=${!!window.dayjs}`);
     el.status.textContent = `Ошибка обработки файла`;
     el.kpis.style.display = "none"; el.charts.style.display = "none"; el.chartsToolbar.style.display = "none"; el.report.style.display="none";
   }finally{
     showLoading(false);
     syncRightHeight();
   }
 }
 
 function getSheetRows(wb, name, maxRows=250) {
@@ -624,105 +703,128 @@ function rebuildCascadeOptions(){
   });
 
   const projPairs   = [...projMap.entries()].sort((a,b)=>a[1].localeCompare(b[1]));
   const typePairs   = [...typeMap.entries()].sort((a,b)=>a[1].localeCompare(b[1]));
   const peoplePairs = [...peopleMap.entries()].sort((a,b)=>a[1].localeCompare(b[1]));
 
   const prevP = el.project.value, prevT = el.type.value, prevS = el.person.value;
   fillSelect(el.project, projPairs, "Проект: все");
   fillSelect(el.type,    typePairs, "Вид работ: все");
   fillSelect(el.person,  peoplePairs, "Исполнитель: все");
   if ([...projMap.keys()].includes(prevP)) el.project.value = prevP; else el.project.value='*';
   if ([...typeMap.keys()].includes(prevT)) el.type.value    = prevT; else el.type.value='*';
   if ([...peopleMap.keys()].includes(prevS)) el.person.value= prevS; else el.person.value='*';
 }
 
 /* ====== ФИЛЬТРАЦИЯ/ОТРИСОВКА ====== */
 function applyFiltersAndRender(initial=false) {
   rebuildCascadeOptions();
 
   const pk = el.project.value, tk = el.type.value, sk = el.person.value, d1 = el.dateFrom.value, d2 = el.dateTo.value;
 
   let t = aq.from(S.raw);
   if (pk !== "*") t = t.filter(aq.escape(d => d.projectKey === pk));
   if (tk !== "*") t = t.filter(aq.escape(d => d.typeKey    === tk));
   if (sk !== "*") t = t.filter(aq.escape(d => d.personKey  === sk));
-  if (d1) t = t.filter(aq.escape(d => d.date !== "(нет даты)" && d.date >= d1));
-  if (d2) t = t.filter(aq.escape(d => d.date !== "(нет даты)" && d.date <= d2));
+  if (d1) t = t.filter(aq.escape(d => d.date === "(нет даты)" || d.date >= d1));
+  if (d2) t = t.filter(aq.escape(d => d.date === "(нет даты)" || d.date <= d2));
 
   S.filtered = t.objects();
   renderAll(initial);
   syncRightHeight();
 }
 
 function renderAll(initial=false) {
   renderSourceTable();
 
   const has = S.filtered.length>0;
   el.kpis.style.display = has ? "" : "none";
   el.charts.style.display = has ? "" : "none";
   el.chartsToolbar.style.display = has ? "" : "none";
   el.report.style.display = has ? "" : "none";
   el.btnExportRaw.disabled = !has;
 
   if (!has){ el.ctxLabel.textContent = ""; el.reportText.textContent=""; return; }
 
   el.ctxLabel.textContent = contextLabel();
   setChartTitles();
   renderKPI();
   renderCharts();
   renderReport(); // только общий адаптивный отчёт (под виджетами текста нет)
 }
 
 /* ====== Заголовки виджетов ====== */
 function setChartTitles(){
   const ctx = contextLabel();
   const suffix = ctx ? ` — ${ctx}` : "";
   el.h3Proj.textContent   = `Часы по проектам (Top 10)${suffix}`;
   el.h3People.textContent = `Часы по исполнителям (Top 10)${suffix}`;
   el.h3Types.textContent  = `Часы по видам работ (Top 10)${suffix}`;
   el.h3Dates.textContent  = `Динамика по дням${suffix}`;
 }
 
 /* ====== Таблица исходной выборки ====== */
 function renderSourceTable(){
   el.tbodySrc.innerHTML = "";
   const rows = S.filtered;
-  el.srcCount.textContent = rows.length ? `Строк: ${rows.length}` : "Пусто";
+  sourceTableState.rendered = 0;
+  sourceTableState.total = rows.length;
+  el.srcCount.textContent = rows.length
+    ? `Строк: ${rows.length}${rows.length > sourceTableState.chunk ? " · прокрутите, чтобы увидеть все" : ""}`
+    : "Пусто";
+  el.srcScroll.scrollTop = 0;
+  appendSourceRows();
+}
+
+function appendSourceRows(){
+  const rows = S.filtered;
+  if (!rows.length) return;
+  if (sourceTableState.rendered >= rows.length) return;
   const frag = document.createDocumentFragment();
-  const cap = Math.min(rows.length, 2000);
-  for (let i=0;i<cap;i++){
+  const start = sourceTableState.rendered;
+  const end = Math.min(start + sourceTableState.chunk, rows.length);
+  for (let i=start;i<end;i++){
     const r = rows[i];
     const tr = document.createElement("tr");
     tr.innerHTML = `<td class="nowrap">${$esc(r.date)}</td>
       <td>${$esc(r.projectDisp)}</td>
       <td>${$esc(r.typeDisp)}</td>
       <td>${$esc(r.personDisp)}</td>
       <td class="nowrap">${fmt2(r.hours)}</td>`;
     frag.appendChild(tr);
   }
   el.tbodySrc.appendChild(frag);
+  sourceTableState.rendered = end;
+}
+
+function handleSourceScroll(){
+  if (!S.filtered.length) return;
+  if (sourceTableState.rendered >= S.filtered.length) return;
+  const node = el.srcScroll;
+  if (node.scrollTop + node.clientHeight >= node.scrollHeight - 24) {
+    appendSourceRows();
+  }
 }
 
 /* ====== KPI ====== */
 function renderKPI() {
   const hours = (aq.from(S.filtered).rollup({h: d => aq.op.sum(d.hours)}).objects()[0] || {h:0}).h || 0;
   const projectCount = new Set(S.filtered.map(r=>r.projectKey)).size;
   const peopleCount  = new Set(S.filtered.map(r=>r.personKey)).size;
   const dayCount     = new Set(S.filtered.map(r=>r.date)).size;
   document.getElementById("kpiHours").textContent   = fmt2(hours);
   document.getElementById("kpiProjects").textContent= projectCount;
   document.getElementById("kpiPeople").textContent  = peopleCount;
   document.getElementById("kpiDays").textContent    = dayCount;
 }
 
 /* ====== ЧАРТЫ ====== */
 function renderCharts() {
   const t = aq.from(S.filtered);
 
   const proj  = t.groupby("projectKey","projectDisp").rollup({h: d => aq.op.sum(d.hours)}).orderby(aq.desc("h"))
                   .objects().map(r=>({key:r.projectKey,label:r.projectDisp,value:r.h}));
   const people= t.groupby("personKey","personDisp").rollup({h: d => aq.op.sum(d.hours)}).orderby(aq.desc("h"))
                   .objects().map(r=>({key:r.personKey,label:r.personDisp,value:r.h}));
   const types = t.groupby("typeKey","typeDisp").rollup({h: d => aq.op.sum(d.hours)}).orderby(aq.desc("h"))
                   .objects().map(r=>({key:r.typeKey,label:r.typeDisp,value:r.h}));
   const byDate= t.filter(aq.escape(d=>d.date!=="(нет даты)")).groupby("date").rollup({h:d=>aq.op.sum(d.hours)}).orderby("date")
@@ -1000,50 +1102,52 @@ function updateHistoryButtons(){
   document.getElementById("btnTypesFwd").disabled =
   document.getElementById("btnDatesFwd").disabled = !hasFwd;
 }
 
 /* ====== СБРОС ====== */
 function clearAll(){
   S.raw = [];
   S.filtered = [];
   S.uniques = {projects:[],types:[],people:[],dates:[]};
   S.limits = {min:null,max:null};
   S.filename = "";
   S.sheets = [];
   S.stack.length = 0;
   S.fwd.length = 0;
 
   el.file.value = "";
   el.sheetSel.innerHTML = `<option value="-1">Лист: авто</option>`;
   el.sheetSel.disabled = true;
 
   el.dateFrom.value = "";
   el.dateTo.value = "";
   ["projectSel","typeSel","personSel"].forEach(id => document.getElementById(id).innerHTML = `<option value="*">—</option>`);
 
   el.tbodySrc.innerHTML = "";
   el.srcCount.textContent = "—";
+  sourceTableState.rendered = 0;
+  sourceTableState.total = 0;
   el.kpis.style.display = "none";
   el.charts.style.display = "none";
   el.chartsToolbar.style.display = "none";
   el.report.style.display = "none";
   el.btnExportRaw.disabled = true;
   el.status.textContent = "Файл очищен";
   clearError();
   updateHistoryButtons();
   syncRightHeight();
 }
 
 /* ====== ЭКСПОРТ ВЫБОРКИ ====== */
 function exportCSVRaw(){
   const rows = S.filtered || [];
   if (!rows.length) return;
 
   const header = [
     `Период: ${el.dateFrom.value||S.limits.min||"-"} — ${el.dateTo.value||S.limits.max||"-"}`,
     `Фильтры: проект=${labelByKey('project', el.project.value)}, вид=${labelByKey('type', el.type.value)}, исполнитель=${labelByKey('person', el.person.value)}`
   ].join("\n") + "\n";
 
   const cols = ["Дата","Проект","Вид работ","Исполнитель","Часы"];
   const csv = header + [cols.join(";")]
     .concat(rows.map(r=>[r.date,r.projectDisp,r.typeDisp,r.personDisp,fmt2(r.hours)].map(v=>String(v).replace(/;/g, ",")).join(";")))
     .join("\n");
@@ -1305,90 +1409,108 @@ function renderReport(){
     const avg2 = sumSeries/byDayFull.length;
     const trend2 = linearTrend(byDayFull);
     const trendTxt2 = trend2.ok ? (trend2.change>0.05 ? `рост (${(trend2.change*100).toFixed(1)}%)`
                         : (trend2.change<-0.05 ? `снижение (${(trend2.change*100).toFixed(1)}%)` : `без выраженного тренда`))
                         : `недостаточно точек для тренда`;
     lines.push(``); lines.push(`ДИНАМИКА ПО ДНЯМ`);
     lines.push(`• Точек: ${byDayFull.length} · Среднее: ${avg2.toFixed(2)} ч/день · Пик: ${peak2.date} — ${peak2.h.toFixed(2)} ч`);
     if (min2) lines.push(`• Минимум (ненулевой): ${min2.date} — ${min2.h.toFixed(2)} ч`);
     lines.push(`• Тренд: ${trendTxt2}`);
   } else {
     lines.push(``); lines.push(`ДИНАМИКА ПО ДНЯМ`);
     lines.push(`• Недостаточно точек для тренда (минимум 8).`);
   }
 
   const anomalies = detectAnomalies(byDayFull, 7, 1.5, 1.3);
   if (anomalies.length){
     lines.push(``); lines.push(`АНОМАЛИИ / ПЕРЕРАБОТКИ`);
     lines.push(`• Дни с превышением порога:`);
     anomalies.slice(0,10).forEach(a=>{
       lines.push(`  - ${a.date}: ${a.h.toFixed(2)} ч (порог ~ ${(Math.max(a.mu*1.3, a.mu+1.5*a.sd)).toFixed(2)} ч)`);
     });
     if (anomalies.length>10) lines.push(`  … и ещё ${anomalies.length-10}`);
   }
 
   const quiet = detectQuietZones(byDayFull, 3);
+  const allZeros = byDayFull.length ? byDayFull.every(p=>!p.h) : false;
   if (quiet.length){
     lines.push(``); lines.push(`ТИХИЕ ЗОНЫ / НЕДОЗАГРУЗКА`);
     quiet.slice(0,10).forEach(z=>{
       lines.push(`• ${z.from} — ${z.to} (${z.len} дн.)`);
     });
     if (quiet.length>10) lines.push(`… и ещё ${quiet.length-10}`);
+  } else if (byDayFull.length){
+    lines.push(``); lines.push(`ТИХИЕ ЗОНЫ / НЕДОЗАГРУЗКА`);
+    if (allZeros){
+      lines.push(`• Все дни в выборке имеют 0 ч — проверьте качество данных или правила парсинга.`);
+    } else {
+      lines.push(`• Тихие зоны (≥3 дней подряд с 0 ч) не обнаружены.`);
+    }
   }
 
   const imbProj = imbalanceInfo(projTop.map(o=>({h:o.h, label:o.projectDisp})), 3, 0.60);
   if (imbProj.trigger){
     lines.push(``); lines.push(`ДИСБАЛАНС / КОНЦЕНТРАЦИЯ`);
     lines.push(`• Доля топ-3 проектов: ${(imbProj.share*100).toFixed(1)}%`);
     lines.push(`• Топ-3:`);
     imbProj.top.forEach((r,i)=>lines.push(`  ${i+1}) ${r.label}: ${r.h.toFixed(2)} ч`));
   }
 
   // Проверки качества входных данных
   const dq = (function(){
-    let noDate=0, zeroH=0, negH=0, emptyProj=0, emptyType=0, emptyPerson=0;
+    let noDate=0, zeroValid=0, negH=0, emptyProj=0, emptyType=0, emptyPerson=0, invalid=0, missingHours=0, malformed=0;
     for (const r of S.filtered){
       if (!r.date || r.date==="(нет даты)") noDate++;
-      if (!Number.isFinite(r.hours) || r.hours===0) zeroH++;
-      if (Number.isFinite(r.hours) && r.hours<0) negH++;
+      if (r.hoursValid && r.hours===0) zeroValid++;
+      if (r.hoursValid && r.hours<0) negH++;
+      if (r.hoursInvalid) invalid++;
+      if (r.hoursMissing) missingHours++;
+      if (r.hoursMalformed) malformed++;
       if (!r.projectDisp || r.projectDisp==="(не задано)") emptyProj++;
       if (!r.typeDisp || r.typeDisp==="(не задано)") emptyType++;
       if (!r.personDisp || r.personDisp==="(не задано)") emptyPerson++;
     }
-    return {noDate, zeroH, negH, emptyProj, emptyType, emptyPerson};
+    return {noDate, zeroValid, negH, emptyProj, emptyType, emptyPerson, invalid, missingHours, malformed};
   })();
-  if (dq.noDate || dq.zeroH || dq.negH || dq.emptyProj || dq.emptyType || dq.emptyPerson){
+  if (dq.noDate || dq.zeroValid || dq.negH || dq.emptyProj || dq.emptyType || dq.emptyPerson || dq.malformed || dq.missingHours){
     lines.push(``); lines.push(`КАЧЕСТВО ДАННЫХ`);
     if (dq.noDate)     lines.push(`• Без даты: ${dq.noDate} записей`);
-    if (dq.zeroH)      lines.push(`• Нулевые часы: ${dq.zeroH} записей`);
+    if (dq.zeroValid)  lines.push(`• Нулевые часы: ${dq.zeroValid} записей`);
     if (dq.negH)       lines.push(`• Отрицательные часы: ${dq.negH} записей`);
+    const problemHours = dq.malformed + dq.missingHours;
+    if (problemHours){
+      lines.push(`• Проблемные значения часов: ${problemHours} записей`);
+      if (dq.malformed)    lines.push(`  ◦ не распознаны (формат): ${dq.malformed}`);
+      if (dq.missingHours) lines.push(`  ◦ пустые/отсутствуют: ${dq.missingHours}`);
+    }
     if (dq.emptyProj)  lines.push(`• Пустой проект: ${dq.emptyProj} записей`);
     if (dq.emptyType)  lines.push(`• Пустой вид работ: ${dq.emptyType} записей`);
     if (dq.emptyPerson)lines.push(`• Пустой исполнитель: ${dq.emptyPerson} записей`);
   }
 
   // Примечание
   lines.push(``); lines.push(`ПРИМЕЧАНИЯ`);
   lines.push(`• Все значения рассчитаны по текущим фильтрам и периоду.`);
   lines.push(`• Пороги: аномалии — >130% скользящего среднего (окно 7 дней) или >1.5σ; тихие зоны — ≥3 подряд дней с 0 ч; дисбаланс — доля топ-3 проектов ≥60%.`);
 
   el.reportText.textContent = lines.join("\n");
 }
 
 
 
 /* ====== СВЯЗЬ ====== */
 el.file.addEventListener("change", (e)=>{ const f = e.target.files?.[0]; if (!f){ el.status.textContent = "Файл не выбран"; return; } S.stack.length=0; S.fwd.length=0; updateHistoryButtons(); parseWorkbook(f, -1); });
 el.btnExportRaw.addEventListener("click", exportCSVRaw);
+el.srcScroll.addEventListener("scroll", handleSourceScroll);
 
 window.addEventListener("load", ()=>{
   const ok = !!(window.XLSX && window.aq && window.dayjs);
   el.status.textContent = ok ? "Готово к загрузке файла" : "Не найдены библиотеки xlsx/arquero/dayjs";
   syncRightHeight();
 });
 window.addEventListener("resize", syncRightHeight);
 window.addEventListener("mousemove", e=>{
   if (!e.target.closest || !e.target.closest('svg, rect, circle')) hideTip();
 });
 </script>
 </body>
 </html>
 